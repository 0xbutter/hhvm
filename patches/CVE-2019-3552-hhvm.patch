From PHID-DIFF-sj5hbmb7vylhpaqgrb7c Mon Sep 17 00:00:00 2001
From: Stepan Palamarchuk <stepan@fb.com>
Date: Tue, 22 Jan 2019 09:54:52 -0800
Subject: [PATCH] Throw on bad types during skipping data

Summary:
The current code silently returns on bad types. In case when we have an invalid data, we may get a container of a large size with a bad type, this would lead to us running long loop doing nothing (though we already can say that the data is invalid).

The new code would throw an exception as soon as we try to skip a value of invalid type.

Fixes CVE-2019-3552

Reviewed By: yfeldblum, stevegury

Differential Revision: D8344920
---

diff --git a/hphp/runtime/ext/thrift/compact.cpp b/hphp/runtime/ext/thrift/compact.cpp
--- a/hphp/runtime/ext/thrift/compact.cpp
+++ b/hphp/runtime/ext/thrift/compact.cpp
@@ -865,6 +865,8 @@
       switch (type) {
         case T_STOP:
         case T_VOID:
+          thrift_error("Encountered invalid type for skipping T_STOP/T_VOID",
+                       ERR_INVALID_DATA);
           break;
 
         case T_STRUCT: {
--
1.7.9.5
