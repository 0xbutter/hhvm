<?php

$format = $argv[1];
$output = $argv[2];
$files = array_slice($argv, 3);

($f = fopen($output, 'w')) || die("cannot open $output");

$FORMAT = strtoupper($format);

fwrite($f, "\n/* Generated by idl_list.php. Do NOT modify. */\n\n");

switch ($format) {
case 'test_ext':
case 'ext':
  fwrite($f, <<<EOT

#ifndef incl_EXT_LIST_{$FORMAT}_H_
#define incl_EXT_LIST_{$FORMAT}_H_


EOT
  );
  break;
}

sort($files);
foreach ($files as $file) {
  preg_match('%^(?:.*/([^/]*)/)?(.*)\.idl\.json$%', $file, $matches);
  $prefix = $matches[1];
  $name = $matches[2];
  $ucname = $prefix ? camelCase($name) : ucfirst($name);

  switch ($format) {
  case 'test_ext':
    $path = $prefix ?: "hphp/test";
    fwrite($f, "#include \"$path/test_ext_$name.h\"\n");
    break;
  case 'test_suites':
    fwrite($f, "RUN_TESTSUITE(TestExt$ucname);\n");
    break;
  case 'ext':
    $path = $prefix ?: "hphp/runtime/ext";
    fwrite($f, "#include \"$path/ext_$name.h\"\n");
    break;
  }
}

switch ($format) {
case 'test_ext':
case 'ext':
  fwrite($f, <<<EOT

#endif // incl_EXT_LIST_{$FORMAT}_H_

EOT
  );
  break;
}

fclose($f);

function camelCase($name) {
  $names = explode('_', $name);
  return implode(array_map("ucfirst", $names));
}
